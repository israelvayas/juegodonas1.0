<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Donut Frenzy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo general para el ambiente retro */
        body {
            font-family: 'Press Start 2P', monospace;
            background-color: #1a1a2e; /* Fondo oscuro retro */
            color: #e5e5f7; /* Texto claro */
            display: flex;
            justify-content: center; /* */
            align-items: center; /* */
            min-height: 100vh; /* */
        }

        /* Estilo para el lienzo del juego (Canvas) */
        #gameCanvas {
            border: 4px solid #f4d03f; /* Borde amarillo de arcade */
            box-shadow: 0 0 20px rgba(244, 208, 63, 0.7), inset 0 0 10px rgba(255, 255, 255, 0.5); /* */
            background-color: #2c3e50; /* Cielo azul oscuro pixeleado */
            cursor: none; /* Ocultar cursor en la zona de juego */
            image-rendering: pixelated; /* ¬°Esencial para el look retro! */
            width: 90vw; /* Ajuste responsive */
            max-width: 600px; /* */
            height: auto; /* */
            aspect-ratio: 4 / 3; /* Relaci√≥n de aspecto 4:3 para mejor visualizaci√≥n */
            touch-action: none; /* Evita el desplazamiento predeterminado del navegador al deslizar */
        }

        /* Estilo para los botones */
        .retro-button {
            background-color: #e74c3c; /* */
            color: #fff; /* */
            padding: 10px 20px;
            margin: 5px;
            border: 4px solid #c0392b;
            box-shadow: 0 5px 0 #922b21;
            transition: all 0.1s;
            text-shadow: 1px 1px 0 #000; /* */
        }
        .retro-button:hover {
            background-color: #c0392b; /* */
            box-shadow: 0 2px 0 #922b21; /* */
            transform: translateY(3px); /* */
        }
        .retro-input {
            background-color: #3b3b54; /* */
            color: #e5e5f7; /* */
            border: 2px solid #f4d03f;
            padding: 8px;
            width: 100%;
            max-width: 300px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); /* */
            font-family: monospace; /* */
        }

        /* Contenedor principal con efecto de pixelado y centrado */
        .game-container {
            width: 100%; /* */
            max-width: 650px; /* */
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center; /* */
        }

        /* Estilo para el Leaderboard (Modal centrado) */
        #leaderboard {
            position: fixed; /* Cambiado a fixed para ser modal */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 350px;
            background-color: rgba(0, 0, 0, 0.9); /* Semi-transparente y oscuro */
            color: #f4d03f;
            border: 4px solid #f4d03f; /* */
            padding: 20px;
            font-size: 10px; /* */
            max-height: 90vh; /* */
            overflow-y: auto;
            z-index: 50; /* Alto z-index para superponer */
        }
        
        /* Estilo para el Panel de Info (Modal centrado) */
        #infoPanel {
            position: fixed; /* Cambiado a fixed para ser modal */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 350px;
            background-color: rgba(0, 0, 0, 0.9); /* Semi-transparente y oscuro */
            color: #e5e5f7; /* */
            border: 4px solid #e74c3c; /* */
            padding: 20px;
            font-size: 10px; /* */
            max-height: 90vh; /* */
            overflow-y: auto;
            z-index: 50; /* Alto z-index para superponer */
        }
        
        /* Estilos de t√≠tulos y elementos internos */
        .leaderboard-title {
            text-align: center; /* */
            font-size: 14px; /* */
            margin-bottom: 5px;
            text-shadow: 1px 1px 0 #e74c3c;
            color: #fff; /* */
        }
        
        .info-title {
            text-align: center; /* */
            font-size: 14px; /* */
            margin-bottom: 5px;
            text-shadow: 1px 1px 0 #3498db;
            color: #fff; /* */
        }

        .leaderboard-item {
            display: flex; /* */
            justify-content: space-between; /* */
            border-bottom: 1px dotted #c0392b;
            padding: 3px 0;
        }
        .leaderboard-item:last-child {
            border-bottom: none; /* */
        }
    </style>
</head>
<body class="p-4">
    
    <div id="infoPanel" class="hidden">
        <h3 class="info-title">GU√çA R√ÅPIDA</h3>
        <div class="mb-3">
            <h4 class="text-sm text-green-400 mb-1">‚úÖ COGE (Puntos/Power-Up)</h4>
            <div class="text-xs">
                <div class="flex items-center mb-1">üç© Dona: +10 Puntos</div>
                <div class="flex items-center mb-1">üåÄ Aspiradora: Cesta m√°s grande.</div>
                <div class="flex items-center mb-1">üõ°Ô∏è Escudo: Resiste 1 golpe extra.</div>
                <div class="flex items-center mb-1">üêå Lento: Ralentiza objetos.</div>
            </div>
        </div>
        <div>
            <h4 class="text-sm text-red-400 mb-1">‚ùå EVITA (¬°Da√±o!)</h4>
            <div class="text-xs">
                <div class="flex items-center mb-1">üí£ Bomba: GAME OVER.</div>
                <div class="flex items-center mb-1">üß± Ladrillo: GAME OVER.</div>
                <div class="flex items-center mb-1">üç© Dona Perdida: GAME OVER.</div>
            </div>
        </div>
        <button id="closeInfoButton" class="retro-button bg-gray-600 border-gray-700 hover:bg-gray-700 text-xs mt-4 w-full">CERRAR</button>
    </div>
    
    <div id="leaderboard" class="hidden">
        <h3 class="leaderboard-title">TOP R√©cords</h3>
        <div id="leaderboardContent">
            <p class="text-center text-xs">Cargando...</p>
        </div>
        <button id="closeLeaderboardButton" class="retro-button bg-gray-600 border-gray-700 hover:bg-gray-700 text-xs mt-4 w-full">CERRAR</button>
    </div>


    <div class="game-container text-center">
        <h1 class="text-3xl mb-4 text-yellow-300 shadow-lg" style="text-shadow: 4px 4px #e74c3c;">PIXEL DONUT FRENZY</h1>
        
        <div id="authScreen" class="p-6 bg-gray-800 border-4 border-yellow-500 rounded-lg max-w-sm mx-auto">
            <h2 class="text-2xl mb-4 text-pink-400">ACCESO</h2>
            <input type="email" id="emailInput" placeholder="EMAIL" class="retro-input mb-3" />
            <input type="password" id="passwordInput" placeholder="CONTRASE√ëA" class="retro-input mb-4" />
            <button id="loginButton" class="retro-button w-full mb-2">INICIAR SESI√ìN</button>
            <button id="registerButton" class="retro-button bg-blue-500 border-blue-700 hover:bg-blue-700 w-full">REGISTRARSE</button>
            <p id="authMessage" class="mt-3 text-sm text-red-400"></p>
        </div>
        
        <div id="profileScreen" class="hidden p-6 bg-gray-800 border-4 border-yellow-500 rounded-lg max-w-sm mx-auto">
            <h2 class="text-2xl mb-4 text-pink-400">COMPLETA TU PERFIL</h2>
            <p class="mb-4 text-sm">Ingresa tu nombre y apellido para el Leaderboard.</p>
            <input type="text" id="nameInput" placeholder="NOMBRE" class="retro-input mb-3" />
            <input type="text" id="lastNameInput" placeholder="APELLIDO" class="retro-input mb-4" />
            <button id="saveProfileButton" class="retro-button bg-green-500 border-green-700 hover:bg-green-700 w-full">GUARDAR Y JUGAR</button>
            <p id="profileMessage" class="mt-3 text-sm text-red-400"></p>
        </div>

        <div id="loadingScreen" class="hidden mt-4">
            <h2 class="text-2xl text-yellow-400">CARGANDO...</h2>
            <p class="mt-2 text-sm">Preparando la m√°quina arcade.</p>
        </div>
        
        <div id="gameScreens" class="hidden">
            <div class="relative max-w-full" style="max-width: 400px; aspect-ratio: 4 / 3;">
                <canvas id="gameCanvas" width="400" height="300"></canvas>
            
                <div id="gameOverScreen" class="absolute inset-0 flex flex-col items-center justify-center p-4 bg-black bg-opacity-75 hidden">
                    <h2 class="text-4xl text-red-500 mb-4" style="text-shadow: 2px 2px #000;">GAME OVER</h2>
                    <button id="startButton" class="retro-button text-lg">REINTENTAR</button>
                </div>
            
                <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center p-4 bg-black bg-opacity-75 hidden">
                    <p class="text-lg mb-4">Usa &larr; y &rarr; (o desliza el dedo) para moverte.</p>
                    <p class="text-lg mb-4 text-red-400">¬°Esquiva bombas y piedras!</p>
                    <button id="initialStartButton" class="retro-button text-xl">EMPEZAR</button>
                </div>
            </div>
            
            <div id="statsPanel" class="mt-4 p-3 bg-gray-800 border-4 border-yellow-500 rounded-lg text-sm grid grid-cols-2 gap-2 w-full" style="font-family: monospace; max-width: 400px;">
                <div class="text-left">USUARIO: <span id="userDisplay" class="text-green-400">...</span></div>
                <div class="text-right">PUNTOS: <span id="scoreDisplay" class="text-green-400">0</span></div>
                <div class="col-span-2 text-center text-yellow-400">R√âCORD: <span id="highScoreDisplay" class="text-pink-400">0</span></div>
                <div class="col-span-2 text-center text-yellow-400">POWER-UP ACTIVO: <span id="powerUpDisplay" class="font-bold">NINGUNO</span></div>
            </div>

            <div class="mt-4 flex justify-center space-x-4 w-full" style="max-width: 400px;">
                <button id="showInfoButton" class="retro-button bg-blue-500 border-blue-700 hover:bg-blue-700 text-sm">GU√çA</button>
                <button id="showLeaderboardButton" class="retro-button bg-purple-500 border-purple-700 hover:bg-purple-700 text-sm">R√âCORDS</button>
                <button id="logoutButton" class="retro-button bg-gray-600 border-gray-700 hover:bg-gray-700 text-sm">CERRAR SESI√ìN</button>
            </div>
        </div>
    </div>

    <script type="module">
        // === CONFIGURACI√ìN GLOBAL DE FIREBASE ===
        // ¬°ESTA ES LA CONFIGURACI√ìN REAL QUE NOS PROPORCIONASTE!
        const firebaseConfig = {
            apiKey: "AIzaSyDvAkI_aBIiezkbSEwgdmpduaGKtw4XLOs",
            authDomain: "controlceo-fdd05.firebaseapp.com",
            projectId: "controlceo-fdd05",
            storageBucket: "controlceo-fdd05.firebasestorage.app",
            messagingSenderId: "207151362101",
            appId: "1:207151362101:web:3ba86ac5680fd41e55417c"
        };
        const appId = firebaseConfig.projectId; // Usamos el projectId como appId de la l√≥gica interna

        // === FIREBASE IMPORTS ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, limit, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // === INICIALIZACI√ìN DE FIREBASE ===
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Referencias a colecciones y documentos
        const getUserDocRef = (userId) => doc(db, `artifacts/${appId}/users/${userId}/data`, "game_stats");
        // Colecci√≥n p√∫blica para el Leaderboard
        const LEADERBOARD_COLLECTION = `artifacts/${appId}/public/data/leaderboard`;
        // === CONFIGURACI√ìN DEL JUEGO ===
        const CANVAS_WIDTH = 400;
        const CANVAS_HEIGHT = 300;
        const PLAYER_SIZE = 30;
        const BASE_SPEED = 1.5;
        const SPAWN_INTERVAL_MS = 1000;
        const OBJECT_SIZE = 25;
        const PLAYER_INITIAL_LIVES = 1;
        const SHIELD_LIVES = 2;

        // Elementos del DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const powerUpDisplay = document.getElementById('powerUpDisplay');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const startButton = document.getElementById('startButton');
        const initialStartButton = document.getElementById('initialStartButton');
        const gameScreens = document.getElementById('gameScreens');
        const userDisplay = document.getElementById('userDisplay');
        // Elementos de autenticaci√≥n y perfil
        const authScreen = document.getElementById('authScreen');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const logoutButton = document.getElementById('logoutButton');
        const authMessage = document.getElementById('authMessage');
        const loadingScreen = document.getElementById('loadingScreen');
        
        const profileScreen = document.getElementById('profileScreen');
        const nameInput = document.getElementById('nameInput');
        const lastNameInput = document.getElementById('lastNameInput');
        const saveProfileButton = document.getElementById('saveProfileButton');
        const profileMessage = document.getElementById('profileMessage');

        // Leaderboard y Panel de Informaci√≥n
        const leaderboard = document.getElementById('leaderboard');
        const leaderboardContent = document.getElementById('leaderboardContent');
        const infoPanel = document.getElementById('infoPanel');
        
        // Nuevos botones de la interfaz
        const showInfoButton = document.getElementById('showInfoButton');
        const showLeaderboardButton = document.getElementById('showLeaderboardButton');
        const closeInfoButton = document.getElementById('closeInfoButton');
        const closeLeaderboardButton = document.getElementById('closeLeaderboardButton');


        // Configuraci√≥n inicial del Canvas
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;
        ctx.imageSmoothingEnabled = false;

        // === ESTADO GLOBAL DEL JUEGO ===
        let score = 0;
        let highScore = 0;
        let isPlaying = false;
        let player;
        let fallingObjects = [];
        let keys = {};
        let lastSpawnTime = 0;
        let animationFrameId;
        let userId = null; 
        let userName = null;

        // Power-Up State
        let activePowerUp = null;
        let powerUpEndTime = 0;
        const POWER_UP_DURATION = 5000;

        // Estado para el control t√°ctil
        let touchX = null;
        
        // === L√ìGICA DE AUTENTICACI√ìN Y DATOS ===

        function setAuthMessage(message, isError = false) {
            authMessage.textContent = message;
            authMessage.className = `mt-3 text-sm ${isError ? 'text-red-400' : 'text-green-400'}`;
        }
        
        function setProfileMessage(message, isError = false) {
            profileMessage.textContent = message;
            profileMessage.className = `mt-3 text-sm ${isError ? 'text-red-400' : 'text-green-400'}`;
        }

        async function loadUserHighScore() {
            if (!userId) return;
            try {
                const docRef = getUserDocRef(userId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    highScore = docSnap.data().highScore || 0;
                } else {
                    // Inicializar el documento si no existe
                    await setDoc(docRef, { highScore: 0 });
                    highScore = 0;
                }
                updateHighScore(highScore);
            } catch (error) {
                console.error("Error al cargar el High Score:", error);
                // No bloquear el juego por esto
            }
        }
        
        // Funci√≥n para guardar el High Score personal
        async function saveUserHighScore(currentScore) {
             if (!userId) return;
             try {
                 const docRef = getUserDocRef(userId);
                 await setDoc(docRef, { highScore: currentScore }, { merge: true });
             } catch (error) {
                 console.error("Error al guardar High Score personal:", error);
             }
        }

        // Nueva funci√≥n para cargar el nombre y apellido del usuario
        function loadUserName() {
            const user = auth.currentUser;
            if (user && user.displayName) {
                userName = user.displayName;
                userDisplay.textContent = userName;
                return true;
            }
            return false;
        }
        
        // Nueva funci√≥n para guardar el high score y el perfil en la colecci√≥n p√∫blica
        async function savePublicRecord(score) {
            if (!userId || !userName || score <= 0) return;
            try {
                const docRef = doc(db, LEADERBOARD_COLLECTION, userId);
                // Cargar el r√©cord actual en la tabla p√∫blica para evitar guardar uno inferior
                const docSnap = await getDoc(docRef);
                const currentPublicScore = docSnap.exists() ? docSnap.data().score : 0;

                if (score > currentPublicScore) {
                    await setDoc(docRef, {
                        userId: userId,
                        userName: userName,
                        score: score,
                        timestamp: Date.now()
                    }, { merge: true });
                    console.log("R√©cord p√∫blico guardado/actualizado:", score);
                }
            } catch (error) {
                console.error("Error al guardar r√©cord p√∫blico:", error);
            }
        }
        
        // Listener de la colecci√≥n p√∫blica para el Leaderboard (en tiempo real)
        const q = query(collection(db, LEADERBOARD_COLLECTION), orderBy("score", "desc"));
        onSnapshot(q, (snapshot) => {
            const records = [];
            snapshot.forEach((doc) => {
                records.push(doc.data());
            });
            renderLeaderboard(records); 
        }, (error) => {
            console.error("Error al escuchar el Leaderboard:", error);
            leaderboardContent.innerHTML = '<p class="text-center text-xs text-red-400">Error al cargar la clasificaci√≥n.</p>';
        });
        
        function renderLeaderboard(records) {
            leaderboardContent.innerHTML = '';

            if (records.length === 0) {
                 leaderboardContent.innerHTML = '<p class="text-center text-xs">S√© el primero en el Leaderboard!</p>';
                 return;
            }
            
            records.forEach((record, index) => {
                const isCurrentUser = record.userId === userId;
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                const name = record.userName.length > 15 ? record.userName.substring(0, 14) + '...' : record.userName;

                // Aplicar estilo de resaltado si es el usuario actual
                const nameClass = isCurrentUser ? 'text-pink-400 font-bold' : '';

                item.innerHTML = `
                    <span class="${nameClass}">${index + 1}. ${name}</span>
                    <span class="${nameClass}">${record.score}</span>
                `;
                leaderboardContent.appendChild(item);
            });
        }


        // Manejadores de Eventos de Auth
        loginButton.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                setAuthMessage("Ingresa email y contrase√±a.", true);
                return;
            }
            setAuthMessage("Iniciando sesi√≥n...");
            try {
                await signInWithEmailAndPassword(auth, email, password);
                setAuthMessage("");
            } catch (error) {
                console.error(error);
                setAuthMessage("Error de sesi√≥n: " + (error.message.includes('user-not-found') ? 'Usuario no encontrado' : 'Credenciales inv√°lidas'), true);
            }
        });
        registerButton.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (password.length < 6) {
                setAuthMessage("La contrase√±a debe tener al menos 6 caracteres.", true);
                return;
            }
            setAuthMessage("Registrando usuario...");
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // No necesitamos setAuthMessage aqu√≠, el onAuthStateChanged se encargar√° de mostrar la pantalla de perfil.
            } catch (error) {
                console.error(error);
                setAuthMessage("Error de registro: " + (error.message.includes('email-already-in-use') ? 'El email ya est√° registrado' : 'Error desconocido'), true);
            }
        });
        saveProfileButton.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            
            if (!name || !lastName) {
                setProfileMessage("Por favor, ingresa tu nombre y apellido.", true);
                return;
            }

            try {
                const user = auth.currentUser;
                const displayName = `${name} ${lastName}`;
                
                await updateProfile(user, { 
                    displayName: displayName 
                });
                
                // Actualizar el estado del juego y la UI
                userName = displayName;
                userDisplay.textContent = userName;

                profileScreen.classList.add('hidden');
                gameScreens.classList.remove('hidden');
                startScreen.classList.remove('hidden');
                
            } catch (error) {
                console.error("Error al guardar perfil:", error);
                setProfileMessage("Error al guardar perfil. Intenta de nuevo.", true);
            }
        });
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error al cerrar sesi√≥n:", error);
            }
        });
        // Listener de estado de autenticaci√≥n (CR√çTICO)
        onAuthStateChanged(auth, (user) => {
            loadingScreen.classList.add('hidden');
            infoPanel.classList.add('hidden');
            leaderboard.classList.add('hidden');
            
            if (user) {
                userId = user.uid;
                
                // 1. Ocultar login
                authScreen.classList.add('hidden');
                
                // 2. Verificar si el perfil est√° completo
                if (loadUserName()) {
                    // Perfil completo, mostrar juego
                    profileScreen.classList.add('hidden');
                    gameScreens.classList.remove('hidden');
                    startScreen.classList.remove('hidden');
                    
                    loadUserHighScore();
                    setAuthMessage("");
                } else {
                    // Perfil incompleto, mostrar pantalla de perfil
                    profileScreen.classList.remove('hidden');
                    gameScreens.classList.add('hidden');
                }

            } else {
                // Usuario no logueado
                gameScreens.classList.add('hidden');
                profileScreen.classList.add('hidden');
                authScreen.classList.remove('hidden');
                userId = null;
                userName = null;
                highScore = 0;
                updateHighScore(0);
                setAuthMessage("Por favor, inicia sesi√≥n para guardar tu r√©cord.", true);
            }
        });
        // === CONFIGURACI√ìN DE AUDIO (TONE.JS) ===
        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "square" },
            envelope: { release: 0.1 }
        }).toDestination();
        const noise = new Tone.NoiseSynth({
             noise: { type: "white" },
             envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.05 }
        }).toDestination();
        const metal = new Tone.MetalSynth().toDestination();

        function playCollectSound() {
            synth.triggerAttackRelease(["C5", "G5"], "16n");
        }

        function playHitSound() {
            noise.triggerAttackRelease("8n", Tone.now(), 0.5);
            metal.triggerAttackRelease("4n", Tone.now() + 0.1, 0.5);
        }

        function playPowerUpSound() {
            synth.triggerAttackRelease(["C6", "E6", "G6", "C7"], "16n");
        }
        
        function playShieldBlockSound() {
            synth.triggerAttackRelease(["D3", "A3"], "8n", Tone.now(), 0.8);
        }
        
        function playGameOverSound() {
            synth.triggerAttackRelease(["C3", "G#2", "F2"], "2n");
            noise.triggerAttackRelease("2n", Tone.now(), 1.0);
        }

        // === IMPLEMENTACI√ìN DE POWER-UPS ===
        const powerUps = {
            'vacuum': {
                symbol: 'üåÄ',
                color: '#3498db',
                name: 'ASPIRADORA',
                effect: () => { player.width = PLAYER_SIZE * 2; },
                cleanup: () => { player.width = PLAYER_SIZE; }
            },
            'shield': {
                symbol: 'üõ°Ô∏è',
                color: '#2ecc71',
                name: 'ESCUDO',
                // El efecto ahora solo establece las vidas, la l√≥gica est√° en handleHit
                effect: () => { player.lives = SHIELD_LIVES; },
                cleanup: () => { player.lives = PLAYER_INITIAL_LIVES; }
            },
            'slow': {
                symbol: 'üêå',
                color: '#f1c40f',
                name: 'LENTO',
                effect: () => {},
                cleanup: () => {}
            }
        };
        // Mapeo de Emojis para los objetos que caen
        const objectSymbols = {
            'donut': 'üç©',
            'bomb': 'üí£',
            'stone': 'üß±',
        };
        // === CLASES DE ENTIDADES ===

        class Player {
            constructor(x, y, size) {
                this.x = x;
                this.y = y;
                this.width = size;
                this.height = size;
                this.speed = 4;
                this.lives = PLAYER_INITIAL_LIVES;
            }

            draw() {
                ctx.font = `${this.height}px sans-serif`;
                ctx.textAlign = 'center';
                const emoji = 'üõí';

                ctx.fillText(emoji, this.x + this.width / 2, this.y + this.height * 0.9);
                // Dibujar el efecto del escudo si las vidas son mayores a 1 (lo que indica que el escudo est√° activo)
                if (this.lives > PLAYER_INITIAL_LIVES) {
                    ctx.fillStyle = 'rgba(46, 204, 113, 0.4)';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.fillStyle = '#2ecc71';
                    ctx.fillRect(this.x, this.y, this.width, 3);
                    ctx.fillRect(this.x, this.y + this.height - 3, this.width, 3);
                }
            }

            update() {
                // Control por teclado (mantener para desktop)
                if (keys['ArrowLeft'] || keys['a']) {
                    this.x -= this.speed;
                }
                if (keys['ArrowRight'] || keys['d']) {
                    this.x += this.speed;
                }
                
                // Control t√°ctil
                if (touchX !== null) {
                    // Mover al jugador directamente a la posici√≥n X del toque (o cerca)
                    const targetX = touchX - this.width / 2;
                    const dx = targetX - this.x;
                    // Suavizar el movimiento (opcional, pero se ve mejor)
                    if (Math.abs(dx) > this.speed) {
                        this.x += Math.sign(dx) * this.speed;
                    } else {
                        this.x = targetX;
                    }
                }

                if (this.x < 0) this.x = 0;
                if (this.x + this.width > CANVAS_WIDTH) this.x = CANVAS_WIDTH - this.width;
            }
        }

        class FallingObject {
            constructor(x, y, type, speed) {
                this.x = x;
                this.y = y;
                this.width = OBJECT_SIZE;
                this.height = OBJECT_SIZE;
                this.type = type;
                this.speed = speed;
            }

            getSymbol() {
                if (powerUps[this.type]) {
                    return powerUps[this.type].symbol;
                }
                return objectSymbols[this.type] || '‚ùì';
            }

            draw() {
                ctx.font = `${this.height}px sans-serif`;
                ctx.textAlign = 'center';

                if (powerUps[this.type]) {
                    ctx.fillStyle = powerUps[this.type].color;
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }

                ctx.fillText(this.getSymbol(), this.x + this.width / 2, this.y + this.height * 0.9);
            }

            update() {
                let currentSpeed = this.speed;
                if (activePowerUp === 'slow' && Date.now() < powerUpEndTime) {
                    currentSpeed *= 0.4;
                }

                this.y += currentSpeed;
                if (activePowerUp === 'vacuum' && Date.now() < powerUpEndTime && this.type === 'donut') {
                    const playerCenterX = player.x + player.width / 2;
                    const objectCenterX = this.x + this.width / 2;
                    const diffX = playerCenterX - objectCenterX;

                    this.x += Math.sign(diffX) * 2;
                }
            }
        }

        // === L√ìGICA DEL JUEGO ===

        function initGame() {
            if (!userId || !userName) {
                // Si el perfil no est√° completo, forzar al usuario a ir a la pantalla de perfil
                profileScreen.classList.remove('hidden');
                gameScreens.classList.add('hidden');
                return;
            }
            if (Tone.context.state !== 'running') {
                Tone.start();
            }

            score = 0;
            updateHighScore(highScore);
            isPlaying = true;
            player = new Player(CANVAS_WIDTH / 2 - PLAYER_SIZE / 2, CANVAS_HEIGHT - PLAYER_SIZE - 10, PLAYER_SIZE);
            fallingObjects = [];
            lastSpawnTime = 0;
            activePowerUp = null;
            powerUpEndTime = 0;
            player.lives = PLAYER_INITIAL_LIVES;
            touchX = null;

            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            document.getElementById('statsPanel').classList.remove('hidden');
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            gameLoop(0);
        }

        function updateHighScore(newScore) {
            if (newScore > highScore) {
                highScore = newScore;
            }
            highScoreDisplay.textContent = highScore;
        }

        function spawnObject(currentTime) {
            const timeElapsed = currentTime - lastSpawnTime;
            const difficultyMultiplier = 1 + Math.floor(score / 150) * 0.1;
            const spawnInterval = SPAWN_INTERVAL_MS / difficultyMultiplier;
            if (timeElapsed > spawnInterval) {
                lastSpawnTime = currentTime;
                const x = Math.random() * (CANVAS_WIDTH - OBJECT_SIZE);
                const speed = BASE_SPEED * difficultyMultiplier;

                let objectType = 'donut';
                const rand = Math.random();

                if (score > 100 && rand < 0.08) { 
                    const types = Object.keys(powerUps);
                    objectType = types[Math.floor(Math.random() * types.length)];
                } else if (rand < 0.2 + (score / 2000)) {
                    if (Math.random() < 0.5) {
                        objectType = 'bomb';
                    } else {
                        objectType = 'stone';
                    }
                }

                fallingObjects.push(new FallingObject(x, -OBJECT_SIZE, objectType, speed));
            }
        }

        function checkCollisions(object, index) {
            // Colisi√≥n con el jugador
            if (
                object.x < player.x + player.width &&
                object.x + object.width > player.x &&
                object.y < player.y + player.height &&
                object.y + object.height > player.y
            ) {
                handleHit(object, index);
                return true;
            }

            // Objeto fuera de la pantalla (perdida)
            if (object.y > CANVAS_HEIGHT) {
                // Si es una dona y se pierde
                if (object.type === 'donut') {
                    // El escudo NO protege de perder donas
                    playHitSound();
                    gameOver();
                    return true;
                }
                
                // Si es un power-up o un peligro que se perdi√≥
                fallingObjects.splice(index, 1);
                return true;
            }

            return false;
        }

        function handleHit(object, index) {
            fallingObjects.splice(index, 1);
            if (object.type === 'donut') {
                score += 10;
                updateHighScore(score);
                playCollectSound();
            } else if (object.type === 'bomb' || object.type === 'stone') {
                
                // L√≥gica de protecci√≥n del escudo
                if (activePowerUp === 'shield' && player.lives > PLAYER_INITIAL_LIVES) {
                    player.lives = PLAYER_INITIAL_LIVES;
                    
                    // Quitar el power-up si era la √∫ltima "vida" extra
                    powerUps[activePowerUp].cleanup();
                    activePowerUp = null;
                    powerUpEndTime = 0;
                    
                    playShieldBlockSound();
                    canvas.style.borderColor = '#3498db';
                    setTimeout(() => canvas.style.borderColor = '#f4d03f', 200);
                } else {
                    // Muerte instant√°nea o sin escudo
                    playHitSound();
                    gameOver();
                }
            } else if (powerUps[object.type]) {
                activatePowerUp(object.type);
            }
        }

        function activatePowerUp(type) {
            if (activePowerUp && activePowerUp !== type) {
                powerUps[activePowerUp].cleanup();
            }

            activePowerUp = type;
            powerUpEndTime = Date.now() + POWER_UP_DURATION;
            // Aplicar el efecto del power-up
            powerUps[activePowerUp].effect();
            powerUpDisplay.textContent = powerUps[activePowerUp].name;
            canvas.style.boxShadow = `0 0 30px 10px ${powerUps[activePowerUp].color}, inset 0 0 15px rgba(255, 255, 255, 0.7)`;
            playPowerUpSound();
        }

        function checkPowerUpExpiry() {
            if (activePowerUp && Date.now() > powerUpEndTime) {
                powerUps[activePowerUp].cleanup();
                activePowerUp = null;
                powerUpDisplay.textContent = 'NINGUNO';
                canvas.style.boxShadow = '0 0 20px rgba(244, 208, 63, 0.7), inset 0 0 10px rgba(255, 255, 255, 0.5)';
            }
        }

        function gameOver() {
            isPlaying = false;
            cancelAnimationFrame(animationFrameId);

            // Tocar el sonido de Game Over
            playGameOverSound();

            // Guardar el r√©cord personal y en la tabla p√∫blica
            if (score > highScore) {
                saveUserHighScore(score);
            }
            if (score > 0 && userName) {
                savePublicRecord(score);
            }

            gameOverScreen.classList.remove('hidden');
            if (activePowerUp) {
                powerUps[activePowerUp].cleanup();
                activePowerUp = null;
            }
            powerUpDisplay.textContent = 'NINGUNO';
            canvas.style.borderColor = '#f4d03f';
            canvas.style.boxShadow = '0 0 20px rgba(244, 208, 63, 0.7), inset 0 0 10px rgba(255, 255, 255, 0.5)';
        }

        function drawGame() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            ctx.font = '10px "Press Start 2P", monospace';
            ctx.textAlign = 'left';
            for (let i = 0; i < fallingObjects.length; i++) {
                fallingObjects[i].draw();
            }

            player.draw();

            scoreDisplay.textContent = score;
            highScoreDisplay.textContent = highScore;
            powerUpDisplay.textContent = activePowerUp ? powerUps[activePowerUp].name : 'NINGUNO';

            if (activePowerUp && Date.now() < powerUpEndTime) {
                const elapsed = Date.now() - (powerUpEndTime - POWER_UP_DURATION);
                const percentage = 1 - (elapsed / POWER_UP_DURATION);
                const barWidth = CANVAS_WIDTH * percentage;

                ctx.fillStyle = powerUps[activePowerUp].color;
                ctx.fillRect(0, 0, barWidth, 5);
            }
        }

        // === BUCLE PRINCIPAL DEL JUEGO ===

        function gameLoop(currentTime) {
            if (!isPlaying) return;
            player.update();
            spawnObject(currentTime);
            checkPowerUpExpiry();

            for (let i = fallingObjects.length - 1; i >= 0; i--) {
                fallingObjects[i].update();
                if (checkCollisions(fallingObjects[i], i)) {
                    // La colisi√≥n/p√©rdida ya fue manejada
                }
            }

            drawGame();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // === EVENTOS DEL JUEGO (TECLADO Y T√ÅCTIL) ===

        initialStartButton.addEventListener('click', initGame);
        startButton.addEventListener('click', initGame);

        // Control por teclado
        document.addEventListener('keydown', (e) => {
            // Permitir 'Enter' para iniciar/reiniciar si no est√° jugando y las pantallas de inicio/gameover son visibles
            if (!isPlaying && (e.key === 'Enter' || e.key === ' ') && (startScreen.classList.contains('hidden') === false || gameOverScreen.classList.contains('hidden') === false)) {
                initGame();
                return;
            }

            if (isPlaying) {
                keys[e.key] = true;
            }
        });
        document.addEventListener('keyup', (e) => {
            if (isPlaying) {
                keys[e.key] = false;
            }
        });
        // --- Control T√°ctil ---
        
        // Funci√≥n auxiliar para obtener la posici√≥n X relativa al canvas
        function getTouchX(e) {
            const rect = canvas.getBoundingClientRect();
            // Mapear la coordenada X del toque (en la pantalla) al tama√±o interno del canvas (400px)
            const x = e.touches[0].clientX - rect.left;
            return (x / rect.width) * CANVAS_WIDTH;
        }

        canvas.addEventListener('touchstart', (e) => {
            if (isPlaying) {
                touchX = getTouchX(e);
            }
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Evitar el desplazamiento de la p√°gina
            if (isPlaying) {
                touchX = getTouchX(e);
            }
        });
        canvas.addEventListener('touchend', () => {
            // Si quieres que el carrito se detenga al levantar el dedo, descomenta la siguiente l√≠nea:
            // touchX = null;
        });
        
        // === EVENTOS DE UTILIDAD (Gu√≠a y Leaderboard) ===
        
        showInfoButton.addEventListener('click', () => {
             // Alternar la visibilidad de la Gu√≠a
             infoPanel.classList.toggle('hidden');
             // Asegurarse de que el otro est√© oculto si estaba abierto
             leaderboard.classList.add('hidden');
        });
        
        closeInfoButton.addEventListener('click', () => {
             infoPanel.classList.add('hidden');
        });

        showLeaderboardButton.addEventListener('click', () => {
             // Alternar la visibilidad del Leaderboard
             leaderboard.classList.toggle('hidden');
             // Asegurarse de que el otro est√© oculto si estaba abierto
             infoPanel.classList.add('hidden');
        });
        
        closeLeaderboardButton.addEventListener('click', () => {
             leaderboard.classList.add('hidden');
        });

    </script>
</body>
</html>